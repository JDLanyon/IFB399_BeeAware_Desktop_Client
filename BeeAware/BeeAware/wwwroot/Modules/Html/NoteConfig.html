<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="conf_style.css">
</head>
<body>
    <table id="myTable" class="styled-table"></table>
    <script>
    window.onload = function(){
        const url = 'https://localhost:7133/api/Module/note_config_get';

        fetch(url, {
            method: 'GET',
            referer: 'about:client',
            credentials: 'same-origin',
            headers: new Headers({ 'content-type': 'application/ json' }),
        })
        .then(function (response) {
                response.json().then(function (data) {
                    console.log(data);
                    // Get table reference
                    const table = document.getElementById('myTable');
                    
                    // Generate headers
                    let header = '<tr>';
                    for (let key in data[0]) {
                        header += `<th>${key}</th>`;
                    }
                    header += `<th>Select Image File</th>`;
                    header += `<th>Submit Button</th>`;
                    header += '</tr>';
                    
                    // Generate rows
                    let rows = '';
                    let rowIndex = 1;
                    for (let obj of data) {
                        rows += '<tr>';
                        columnIndex = 0;
                        for (let val in obj) {
                            if(columnIndex == 2)
                            {
                                // image to string 
                                rows += `<td><img class="noteImg" src="data:image/png;base64,${obj[val]}" alt="image" width="100" height="100"></td>`;
                            }
                            else{
                                rows += `<td contenteditable="true">${obj[val]}</td>`; 
                            }
                            columnIndex++;
                        }
                        rows += `<td><input type="file" id="inputFile${rowIndex}" class="fileInput" accept="image/*" capture="camera"></td>`;
                        rows += `<td><button class="submit" onclick="submitRow(${rowIndex})">Submit</button></td>`;
                        rows += '</tr>';
                        rowIndex++;
                    }
                    
                    // Set innerHTML
                    table.innerHTML = header + rows;
                    // get all the input file elements
                    var fileInput = document.getElementsByClassName('fileInput');
                    var images = document.getElementsByClassName('noteImg');
                    // add event listener to all the input file elements
                    for (var i = 0; i < fileInput.length; i++) {
                        // 监听选择文件事件
                        fileInput[i].addEventListener('change', (e) => {
                        // 获取选择的文件
                        const file = e.target.files[0];
                        // 使用FileReader读取文件
                        const reader = new FileReader();
                        reader.onload = (e2) => {
                            // get id 
                            var id = e.target.getAttribute('id');
                            // remove inputFile in string 
                            var index = parseInt(id.replace('inputFile', ''));
                            var images = document.getElementsByClassName('noteImg');
                            const base64String = e2.target.result; 
                            images[index - 1].src = base64String;
                        };
                        
                        // 以DataURL的格式读取文件内容
                        reader.readAsDataURL(file);
                        });
                    }
                });
            })
        };

        function submitRow(t_rowIndex){
            const table = document.getElementById('myTable');
            const row = table.rows[t_rowIndex];
            const cells = row.cells;
            const data = JSON.stringify({
                // HiveInspectionNoteID, HiveInspectionID image Notes
                "HiveInspectionNoteID": parseInt(cells[0].innerHTML),
                "HiveInspectionID": parseInt(cells[1].innerHTML),
                // "image": cells[2].children[0].getAttribute('src'),
                "image": cells[2].children[0].getAttribute('src').split(',')[1],
                "Notes": cells[3].innerHTML,
            })
            const url = 'https://localhost:7133/api/Module/note_config_post';
            fetch(url, {
                method: 'POST',
                referer: 'about:client',
                credentials: 'same-origin',
                headers: new Headers({ 'content-type': 'application/ json' }),
                body: data
            })
            .then(function (response) {
                response.json().then(function (data) {
                    if (response.status == 202) {
                        alert('Data submitted successfully');
                        console.log('Data submitted successfully');
                    } else {
                        alert('Data submission failed');
                        console.log('Data submission failed');
                    }
                });
            })
        }
    </script>
</body>
</html>
